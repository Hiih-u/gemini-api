events {
    worker_connections 1024;
}

http {
    # å®šä¹‰åç«¯æœåŠ¡å™¨ç»„
    upstream gemini_backend {
        # ğŸ”¥ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ ğŸ”¥
        # 1. å‘Šè¯‰ Nginx è¯»å–è¯·æ±‚å¤´ä¸­çš„ "X-Conversation-ID"
        # 2. consistent è¡¨ç¤ºä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³• (å³ä½¿åŠ å‡æœåŠ¡å™¨ï¼Œå¤§å¾—å¤šçš„ç¼“å­˜ä¹Ÿä¸ä¼šå¤±æ•ˆ)
        # 3. å¦‚æœè¯·æ±‚å¤´é‡Œæ²¡æœ‰è¿™ä¸ª IDï¼ŒNginx ä¼šé€€åŒ–æˆè½®è¯¢æ¨¡å¼
        hash $http_x_conversation_id consistent;

        server gemini-kasm-1:8000;
        server gemini-kasm-2:8000;

        # å»ºè®®å¼€å¯é•¿è¿æ¥
        keepalive 32;
    }

    server {
        listen 80;

        location / {
            proxy_pass http://gemini_backend;

            # åŸºç¡€é€ä¼ 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # è¶…æ—¶è®¾ç½® (ä¿æŒä¹‹å‰çš„ 300s)
            proxy_read_timeout 300s;
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
        }
    }
}